<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js/websocket.js - Quetzalcoatl</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.7.0/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Roboto:300">
    <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Inconsolata:400">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
        
	    <img alt="Quetzalcoatl" src="../assets/css/logo.png" style="max-height: 65%;" title="Quetzalcoatl">
        
            Quetzalcoatl
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs Version: <b>1.0.0</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/cursor", "classes/gestures", "classes/text", "classes/websocket", "modules/quetzalcoatl"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
    <h3>APIs</h3>
    <div id="sidebar">
        <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
            <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
            <li><a href="#modules" data-toggle="tab">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" placeholder="Type to filter APIs">
        </div>

        <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
            <div class="tab-pane active" id="classes">
                <ul id="api-classes" class="nav nav-list">
                    
                        <li><a href="../classes/cursor.html">cursor</a></li>
                    
                        <li><a href="../classes/gestures.html">gestures</a></li>
                    
                        <li><a href="../classes/text.html">text</a></li>
                    
                        <li><a href="../classes/websocket.html">websocket</a></li>
                    
                </ul>
            </div>

            <div class="tab-pane" id="modules">
                <ul id="api-modules" class="nav nav-list">
                    
                        <li><a href="../modules/quetzalcoatl.html">quetzalcoatl</a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</div>

        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <div class="page-header">
    <h1>js/websocket.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
/**
 * The main backbone of the Quetzalcoatl front-end. This code must be used in
 * conjunction with the WebSocket server interfacing with the Kinect for Windows
 * API found at /server, and the Kinect for Windows V2.
 *
 * @module quetzalcoatl
 * @author Lim Mingjie, Kenneth
 * @author Leart Albert Ulaj
 * @requires jQuery, HTML5 WebSocket API
 */

/**
 * Provides the websocket class. Data coming from the Kinect is received by
 * listening on a WebSocket server running either locally or at an exposed address.
 * This class provides core functions for connecting to and disconnecting from
 * the server, as well as helper methods for parsing incoming data.
 *
 * @class websocket
 */

// Set to true to emit verbose output to the console
var debug = true;

// Initialize a stack to hold data from all previous frames
var coordData = [];

// Initialize variables to keep track of whether we are in the middle of a pull gesture
var lpullState = false,
    rpullState = false;

// Set the socket address to match the port which the C# WebSocket Server is broadcasting on
var socketAddress = &quot;ws://localhost:1620/KinectApp&quot;;

if (debug === false) {
    // Initialize a handler for the console element
    var consoleelem = document.getElementById(&quot;console&quot;);

    // Hide the console since console output is not requested
    consoleelem.style.display = &quot;none&quot;;
} else {
    // Set the initial state of the server to &quot;Disconnected&quot;
    updateConsoleServer(false);
}

////////////////////////////////////////////////////////////////////////////////

// Implements the Exponential Backoff Algorithm to spread out reconnection attempts
// so we don&#x27;t flood the server with too many requests in the event that we go offline
//
// ALGORITHM SCHEMA:
// 1. For k attempts, generate a random interval of time between 0 and 2^k - 1.
// 2. If we are able to reconnect, reset k to 1
// 3. If reconnection fails, k increases by 1 and the process restarts at step 1.
// 4. To truncate the max interval, when a certain number of attempts k has
//    been reached, k stops increasing after each attempt.
//
// Input: Unit
// Output: Unit
function createWebSocket() {
    var attempts = 1;

    if (debug === true) {
        console.log(&quot;Initializing connection with &quot; + socketAddress);
        document.getElementById(&quot;serverstatus&quot;).innerText = &quot;Initializing&quot;;
    }

    var connection = new WebSocket(socketAddress);

    // First-run logic when the connection to the server is initialized
    connection.onopen = function() {
        // Reset the tries back to 1 since we have a new connection opened
        attempts = 1;

        if (debug === true) {
            console.log(&quot;Successfully established connection with server.&quot;);
            updateConsoleServer(true);
        }
    };

    // Logic when a message is received from the server
    connection.onmessage = function(event) {
        if (typeof event.data === &quot;string&quot;) {
            // Parse the JSON
            var data = JSON.parse(event.data);

            // Push the new frame onto the stack
            coordData.push(data);

            // Average the data over a pair of frames for increased accuracy
            // FIXME: Dynamically change the framerate depending on what the user is doing
            var averagedData = averageFrames(coordData, 2);

            // Calculate the precision threshold value for each hand
            var lthreshold = cursorThreshold(averagedData.lhandState),
                rthreshold = cursorThreshold(averagedData.rhandState);

            // Map the coordinates from the Kinect space to screen space
            var lcoord = mapCoordinates([averagedData.lx, averagedData.ly], data.screenw, data.screenh, data.sx, data.sy, lthreshold),
                rcoord = mapCoordinates([averagedData.rx, averagedData.ry], data.screenw, data.screenh, data.sx, data.sy, rthreshold);

            if (debug === true) {
                // Update the output on the screen console
                updateConsole(lcoord, data.lhandState, rcoord, data.rhandState);
            }

            // FIXME: Temporary code to enable the pull gestures. Will eventually be
            // abstracted to something more robust
            if (lpullState === false) {
                if (data.lp === true) {
                    pull(lcoord);
                    lpullState = true;
                }
            } else {
                if (data.lp === false) {
                    lpullState = false;
                }
            }

            if (rpullState === false) {
                if (data.rp === true) {
                    pull(rcoord);
                    rpullState = true;
                }
            } else {
                if (data.rp === false) {
                    rpullState = false;
                }
            }

            // Draw the cursor on the screen
            // Only redraw if there are no pull gestures being executed on-screen
            if (lpullState === false &amp;&amp; rpullState === false) {
                reDraw(lcoord, averagedData.lhandState, rcoord, averagedData.rhandState);
            }
        }
    };

    connection.onclose = function() {
        var time = generateInterval(attempts);

        if (debug === true) {
            console.log(&quot;Server connection lost. Retrying in &quot; + time);
            updateConsoleServer(false);
        }

        setTimeout(function() {
            // We&#x27;ve tried to reconnect so increment the attempt counter
            attempts++;

            // Connection has closed so try to reconnect every 10 seconds
            createWebSocket();
        }, time);
    };
}

// An instance generates an back-off interval for making server connections
// Input: Integer of attempts made at connection
// Output: Float of back-off interval (in microseconds)
function generateInterval(k) {
    var maxInterval = (Math.pow(2, k) - 1) * 1000;

    // If the generated interval is more than 30 seconds, truncate it down to 30 seconds
    if (maxInterval &gt; 30 * 1000) {
        maxInterval = 30 * 1000;
    }

    // Generate the interval as a random number between 0 and the maxInterval determined from above
    return Math.random() * maxInterval;
}

// An instance updates the console on the bottom right of the screen with the server status
// Input: Boolean of server state (connected: true | closed: false)
// Output: Unit
function updateConsoleServer(state) {
    var serverstatus = document.getElementById(&quot;serverstatus&quot;);
    if (state === true) {
        // If the server is connected, display &quot;Connected&quot; in green
        serverstatus.innerText = &quot;Connected&quot;;
        serverstatus.style.color = &quot;#859900&quot;;
    } else {
        // If the server is disconnected, display &quot;Disconnected&quot; in red
        serverstatus.innerText = &quot;Disconnected&quot;;
        serverstatus.style.color = &quot;#dc322f&quot;;
    }
}

// Start the web socket connection
// createWebSocket();

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
inlineMath: [ ['$','$'], ["\\(","\\)"] ],
displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
processEscapes: true
},
"HTML-CSS": { availableFonts: ["TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
